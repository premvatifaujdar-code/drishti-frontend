<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ”¥ Drishti Auth Test Panel</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button, textarea { width: 100%; margin: 6px 0; padding: 8px; }
    button { cursor: pointer; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>
<body>

<h2>ðŸ”¥ Drishti â€“ Auth & Protected API Test</h2>

<input id="email" type="email" placeholder="Email" />
<input id="password" type="password" placeholder="Password" />

<button onclick="login()">Login & Get ID Token</button>

<h3>ID TOKEN</h3>
<textarea id="tokenBox" rows="6" readonly></textarea>

<hr>


<button onclick="getMyPosts()">Get My Posts</button>

  
<button onclick="verifyToken()">Verify Token</button>
<button onclick="syncUser()">Sync User (Firestore)</button>
<button onclick="createPost()">Create Protected Post</button>

<h3>RESULT</h3>
<pre id="result">---</pre>

<!-- ================= FINAL SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB1fEntfaINpsA8AZCMGBo5AcMOGSSAqpQ",
  authDomain: "drishti-705e0.firebaseapp.com",
  projectId: "drishti-705e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* ================= GLOBAL TOKEN ================= */
let ID_TOKEN = "";

/* ================= UI HELPER ================= */
function show(msg) {
  document.getElementById("result").textContent = msg;
}

/* ================= LOGIN ================= */
window.login = async () => {
  try {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    const cred = await signInWithEmailAndPassword(auth, email, password);
    ID_TOKEN = await cred.user.getIdToken(true);

    document.getElementById("tokenBox").value = ID_TOKEN;
    show("âœ… Login successful. Token generated.");
  } catch (e) {
    show("âŒ Login error: " + e.message);
  }
};

/* ================= COMMON API CALL ================= */
async function callAPI(url, method, body = null) {
  if (!ID_TOKEN) {
    show("âŒ Please login first");
    return;
  }

  try {
    const res = await fetch(url, {
      method,
      headers: {
        "Authorization": "Bearer " + ID_TOKEN,
        "Content-Type": "application/json"
      },
      body: body ? JSON.stringify(body) : null
    });

    const data = await res.json();
    show(JSON.stringify(data, null, 2));
  } catch (e) {
    show("âŒ Backend error");
  }
}

/* ================= STEP-4 APIs ================= */

window.getMyPosts = async () => {
  if (!ID_TOKEN) {
    document.getElementById("result").textContent =
      "âŒ Login first";
    return;
  }

  try {
    const res = await fetch(
      "https://drishti-backend-one.vercel.app/api/creator/post/my",
      {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + ID_TOKEN,
        }
      }
    );

    const data = await res.json();
    document.getElementById("result").textContent =
      JSON.stringify(data, null, 2);
  } catch (err) {
    document.getElementById("result").textContent =
      "âŒ Error fetching posts";
  }
};

  
window.verifyToken = () =>
  callAPI(
    "https://drishti-backend-one.vercel.app/api/auth/verify",
    "GET"
  );

/* ================= STEP-5 ================= */
window.syncUser = () =>
  callAPI(
    "https://drishti-backend-one.vercel.app/api/user/sync",
    "POST"
  );

/* ================= STEP-6 (PROTECTED API) ================= */
window.createPost = () =>
  callAPI(
    "https://drishti-backend-one.vercel.app/api/posts/create",
    "POST",
    {
      title: "Hello Drishti",
      content: "This is my first protected post"
    }
  );
</script>

</body>
</html>
